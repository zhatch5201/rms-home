{"ast":null,"code":"\"use strict\";\n/*!\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nvar _createForOfIteratorHelper = require(\"C:/Users/Zack/Desktop/rms-home/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\");\n\nvar _objectSpread = require(\"C:/Users/Zack/Desktop/rms-home/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/objectSpread2\");\n\nvar _classCallCheck = require(\"C:/Users/Zack/Desktop/rms-home/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _inherits = require(\"C:/Users/Zack/Desktop/rms-home/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/inherits\");\n\nvar _createSuper = require(\"C:/Users/Zack/Desktop/rms-home/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createSuper\");\n\nvar _wrapNativeSuper = require(\"C:/Users/Zack/Desktop/rms-home/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/wrapNativeSuper\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.teenyRequest = exports.RequestError = void 0;\n\nvar node_fetch_1 = require(\"node-fetch\");\n\nvar stream_1 = require(\"stream\");\n\nvar uuid = require(\"uuid\");\n\nvar agents_1 = require(\"./agents\");\n\nvar TeenyStatistics_1 = require(\"./TeenyStatistics\"); // eslint-disable-next-line @typescript-eslint/no-var-requires\n\n\nvar streamEvents = require('stream-events');\n\nvar RequestError = /*#__PURE__*/function (_Error) {\n  _inherits(RequestError, _Error);\n\n  var _super = _createSuper(RequestError);\n\n  function RequestError() {\n    _classCallCheck(this, RequestError);\n\n    return _super.apply(this, arguments);\n  }\n\n  return RequestError;\n}( /*#__PURE__*/_wrapNativeSuper(Error));\n\nexports.RequestError = RequestError;\n/**\n * Convert options from Request to Fetch format\n * @private\n * @param reqOpts Request options\n */\n\nfunction requestToFetchOptions(reqOpts) {\n  var options = _objectSpread(_objectSpread({\n    method: reqOpts.method || 'GET'\n  }, reqOpts.timeout && {\n    timeout: reqOpts.timeout\n  }), typeof reqOpts.gzip === 'boolean' && {\n    compress: reqOpts.gzip\n  });\n\n  if (typeof reqOpts.json === 'object') {\n    // Add Content-type: application/json header\n    reqOpts.headers = reqOpts.headers || {};\n    reqOpts.headers['Content-Type'] = 'application/json'; // Set body to JSON representation of value\n\n    options.body = JSON.stringify(reqOpts.json);\n  } else {\n    if (typeof reqOpts.body !== 'string') {\n      options.body = JSON.stringify(reqOpts.body);\n    } else {\n      options.body = reqOpts.body;\n    }\n  } // eslint-disable-next-line @typescript-eslint/no-explicit-any\n\n\n  options.headers = reqOpts.headers;\n  var uri = reqOpts.uri || reqOpts.url;\n\n  if (reqOpts.useQuerystring === true || typeof reqOpts.qs === 'object') {\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    var qs = require('querystring');\n\n    var params = qs.stringify(reqOpts.qs);\n    uri = uri + '?' + params;\n  }\n\n  options.agent = agents_1.getAgent(uri, reqOpts);\n  return {\n    uri: uri,\n    options: options\n  };\n}\n/**\n * Convert a response from `fetch` to `request` format.\n * @private\n * @param opts The `request` options used to create the request.\n * @param res The Fetch response\n * @returns A `request` response object\n */\n\n\nfunction fetchToRequestResponse(opts, res) {\n  var request = {};\n  request.agent = opts.agent || false;\n  request.headers = opts.headers || {};\n  request.href = res.url; // headers need to be converted from a map to an obj\n\n  var resHeaders = {};\n  res.headers.forEach(function (value, key) {\n    return resHeaders[key] = value;\n  });\n  var response = Object.assign(res.body, {\n    statusCode: res.status,\n    statusMessage: res.statusText,\n    request: request,\n    body: res.body,\n    headers: resHeaders,\n    toJSON: function toJSON() {\n      return {\n        headers: resHeaders\n      };\n    }\n  });\n  return response;\n}\n/**\n * Create POST body from two parts as multipart/related content-type\n * @private\n * @param boundary\n * @param multipart\n */\n\n\nfunction createMultipartStream(boundary, multipart) {\n  var finale = \"--\".concat(boundary, \"--\");\n  var stream = new stream_1.PassThrough();\n\n  var _iterator = _createForOfIteratorHelper(multipart),\n      _step;\n\n  try {\n    for (_iterator.s(); !(_step = _iterator.n()).done;) {\n      var part = _step.value;\n      var preamble = \"--\".concat(boundary, \"\\r\\nContent-Type: \").concat(part['Content-Type'], \"\\r\\n\\r\\n\");\n      stream.write(preamble);\n\n      if (typeof part.body === 'string') {\n        stream.write(part.body);\n        stream.write('\\r\\n');\n      } else {\n        part.body.pipe(stream, {\n          end: false\n        });\n        part.body.on('end', function () {\n          stream.write('\\r\\n');\n          stream.write(finale);\n          stream.end();\n        });\n      }\n    }\n  } catch (err) {\n    _iterator.e(err);\n  } finally {\n    _iterator.f();\n  }\n\n  return stream;\n}\n\nfunction teenyRequest(reqOpts, callback) {\n  var _requestToFetchOption = requestToFetchOptions(reqOpts),\n      uri = _requestToFetchOption.uri,\n      options = _requestToFetchOption.options;\n\n  var multipart = reqOpts.multipart;\n\n  if (reqOpts.multipart && multipart.length === 2) {\n    if (!callback) {\n      // TODO: add support for multipart uploads through streaming\n      throw new Error('Multipart without callback is not implemented.');\n    }\n\n    var boundary = uuid.v4();\n    options.headers['Content-Type'] = \"multipart/related; boundary=\".concat(boundary);\n    options.body = createMultipartStream(boundary, multipart); // Multipart upload\n\n    teenyRequest.stats.requestStarting();\n    node_fetch_1.default(uri, options).then(function (res) {\n      teenyRequest.stats.requestFinished();\n      var header = res.headers.get('content-type');\n      var response = fetchToRequestResponse(options, res);\n      var body = response.body;\n\n      if (header === 'application/json' || header === 'application/json; charset=utf-8') {\n        res.json().then(function (json) {\n          response.body = json;\n          callback(null, response, json);\n        }, function (err) {\n          callback(err, response, body);\n        });\n        return;\n      }\n\n      res.text().then(function (text) {\n        response.body = text;\n        callback(null, response, text);\n      }, function (err) {\n        callback(err, response, body);\n      });\n    }, function (err) {\n      teenyRequest.stats.requestFinished();\n      callback(err, null, null);\n    });\n    return;\n  }\n\n  if (callback === undefined) {\n    // Stream mode\n    var requestStream = streamEvents(new stream_1.PassThrough()); // eslint-disable-next-line @typescript-eslint/no-explicit-any\n\n    var responseStream;\n    requestStream.once('reading', function () {\n      if (responseStream) {\n        responseStream.pipe(requestStream);\n      } else {\n        requestStream.once('response', function () {\n          responseStream.pipe(requestStream);\n        });\n      }\n    });\n    options.compress = false;\n    teenyRequest.stats.requestStarting();\n    node_fetch_1.default(uri, options).then(function (res) {\n      teenyRequest.stats.requestFinished();\n      responseStream = res.body;\n      responseStream.on('error', function (err) {\n        requestStream.emit('error', err);\n      });\n      var response = fetchToRequestResponse(options, res);\n      requestStream.emit('response', response);\n    }, function (err) {\n      teenyRequest.stats.requestFinished();\n      requestStream.emit('error', err);\n    }); // fetch doesn't supply the raw HTTP stream, instead it\n    // returns a PassThrough piped from the HTTP response\n    // stream.\n\n    return requestStream;\n  } // GET or POST with callback\n\n\n  teenyRequest.stats.requestStarting();\n  node_fetch_1.default(uri, options).then(function (res) {\n    teenyRequest.stats.requestFinished();\n    var header = res.headers.get('content-type');\n    var response = fetchToRequestResponse(options, res);\n    var body = response.body;\n\n    if (header === 'application/json' || header === 'application/json; charset=utf-8') {\n      if (response.statusCode === 204) {\n        // Probably a DELETE\n        callback(null, response, body);\n        return;\n      }\n\n      res.json().then(function (json) {\n        response.body = json;\n        callback(null, response, json);\n      }, function (err) {\n        callback(err, response, body);\n      });\n      return;\n    }\n\n    res.text().then(function (text) {\n      var response = fetchToRequestResponse(options, res);\n      response.body = text;\n      callback(null, response, text);\n    }, function (err) {\n      callback(err, response, body);\n    });\n  }, function (err) {\n    teenyRequest.stats.requestFinished();\n    callback(err, null, null);\n  });\n  return;\n}\n\nexports.teenyRequest = teenyRequest;\n\nteenyRequest.defaults = function (defaults) {\n  return function (reqOpts, callback) {\n    var opts = _objectSpread(_objectSpread({}, defaults), reqOpts);\n\n    if (callback === undefined) {\n      return teenyRequest(opts);\n    }\n\n    teenyRequest(opts, callback);\n  };\n};\n/**\n * Single instance of an interface for keeping track of things.\n */\n\n\nteenyRequest.stats = new TeenyStatistics_1.TeenyStatistics();\n\nteenyRequest.resetStats = function () {\n  teenyRequest.stats = new TeenyStatistics_1.TeenyStatistics(teenyRequest.stats.getOptions());\n};","map":{"version":3,"sources":["../../src/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n/*!\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.teenyRequest = exports.RequestError = void 0;\nconst node_fetch_1 = require(\"node-fetch\");\nconst stream_1 = require(\"stream\");\nconst uuid = require(\"uuid\");\nconst agents_1 = require(\"./agents\");\nconst TeenyStatistics_1 = require(\"./TeenyStatistics\");\n// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst streamEvents = require('stream-events');\nclass RequestError extends Error {\n}\nexports.RequestError = RequestError;\n/**\n * Convert options from Request to Fetch format\n * @private\n * @param reqOpts Request options\n */\nfunction requestToFetchOptions(reqOpts) {\n    const options = {\n        method: reqOpts.method || 'GET',\n        ...(reqOpts.timeout && { timeout: reqOpts.timeout }),\n        ...(typeof reqOpts.gzip === 'boolean' && { compress: reqOpts.gzip }),\n    };\n    if (typeof reqOpts.json === 'object') {\n        // Add Content-type: application/json header\n        reqOpts.headers = reqOpts.headers || {};\n        reqOpts.headers['Content-Type'] = 'application/json';\n        // Set body to JSON representation of value\n        options.body = JSON.stringify(reqOpts.json);\n    }\n    else {\n        if (typeof reqOpts.body !== 'string') {\n            options.body = JSON.stringify(reqOpts.body);\n        }\n        else {\n            options.body = reqOpts.body;\n        }\n    }\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    options.headers = reqOpts.headers;\n    let uri = (reqOpts.uri ||\n        reqOpts.url);\n    if (reqOpts.useQuerystring === true || typeof reqOpts.qs === 'object') {\n        // eslint-disable-next-line @typescript-eslint/no-var-requires\n        const qs = require('querystring');\n        const params = qs.stringify(reqOpts.qs);\n        uri = uri + '?' + params;\n    }\n    options.agent = agents_1.getAgent(uri, reqOpts);\n    return { uri, options };\n}\n/**\n * Convert a response from `fetch` to `request` format.\n * @private\n * @param opts The `request` options used to create the request.\n * @param res The Fetch response\n * @returns A `request` response object\n */\nfunction fetchToRequestResponse(opts, res) {\n    const request = {};\n    request.agent = opts.agent || false;\n    request.headers = (opts.headers || {});\n    request.href = res.url;\n    // headers need to be converted from a map to an obj\n    const resHeaders = {};\n    res.headers.forEach((value, key) => (resHeaders[key] = value));\n    const response = Object.assign(res.body, {\n        statusCode: res.status,\n        statusMessage: res.statusText,\n        request,\n        body: res.body,\n        headers: resHeaders,\n        toJSON: () => ({ headers: resHeaders }),\n    });\n    return response;\n}\n/**\n * Create POST body from two parts as multipart/related content-type\n * @private\n * @param boundary\n * @param multipart\n */\nfunction createMultipartStream(boundary, multipart) {\n    const finale = `--${boundary}--`;\n    const stream = new stream_1.PassThrough();\n    for (const part of multipart) {\n        const preamble = `--${boundary}\\r\\nContent-Type: ${part['Content-Type']}\\r\\n\\r\\n`;\n        stream.write(preamble);\n        if (typeof part.body === 'string') {\n            stream.write(part.body);\n            stream.write('\\r\\n');\n        }\n        else {\n            part.body.pipe(stream, { end: false });\n            part.body.on('end', () => {\n                stream.write('\\r\\n');\n                stream.write(finale);\n                stream.end();\n            });\n        }\n    }\n    return stream;\n}\nfunction teenyRequest(reqOpts, callback) {\n    const { uri, options } = requestToFetchOptions(reqOpts);\n    const multipart = reqOpts.multipart;\n    if (reqOpts.multipart && multipart.length === 2) {\n        if (!callback) {\n            // TODO: add support for multipart uploads through streaming\n            throw new Error('Multipart without callback is not implemented.');\n        }\n        const boundary = uuid.v4();\n        options.headers['Content-Type'] = `multipart/related; boundary=${boundary}`;\n        options.body = createMultipartStream(boundary, multipart);\n        // Multipart upload\n        teenyRequest.stats.requestStarting();\n        node_fetch_1.default(uri, options).then(res => {\n            teenyRequest.stats.requestFinished();\n            const header = res.headers.get('content-type');\n            const response = fetchToRequestResponse(options, res);\n            const body = response.body;\n            if (header === 'application/json' ||\n                header === 'application/json; charset=utf-8') {\n                res.json().then(json => {\n                    response.body = json;\n                    callback(null, response, json);\n                }, (err) => {\n                    callback(err, response, body);\n                });\n                return;\n            }\n            res.text().then(text => {\n                response.body = text;\n                callback(null, response, text);\n            }, err => {\n                callback(err, response, body);\n            });\n        }, err => {\n            teenyRequest.stats.requestFinished();\n            callback(err, null, null);\n        });\n        return;\n    }\n    if (callback === undefined) {\n        // Stream mode\n        const requestStream = streamEvents(new stream_1.PassThrough());\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        let responseStream;\n        requestStream.once('reading', () => {\n            if (responseStream) {\n                responseStream.pipe(requestStream);\n            }\n            else {\n                requestStream.once('response', () => {\n                    responseStream.pipe(requestStream);\n                });\n            }\n        });\n        options.compress = false;\n        teenyRequest.stats.requestStarting();\n        node_fetch_1.default(uri, options).then(res => {\n            teenyRequest.stats.requestFinished();\n            responseStream = res.body;\n            responseStream.on('error', (err) => {\n                requestStream.emit('error', err);\n            });\n            const response = fetchToRequestResponse(options, res);\n            requestStream.emit('response', response);\n        }, err => {\n            teenyRequest.stats.requestFinished();\n            requestStream.emit('error', err);\n        });\n        // fetch doesn't supply the raw HTTP stream, instead it\n        // returns a PassThrough piped from the HTTP response\n        // stream.\n        return requestStream;\n    }\n    // GET or POST with callback\n    teenyRequest.stats.requestStarting();\n    node_fetch_1.default(uri, options).then(res => {\n        teenyRequest.stats.requestFinished();\n        const header = res.headers.get('content-type');\n        const response = fetchToRequestResponse(options, res);\n        const body = response.body;\n        if (header === 'application/json' ||\n            header === 'application/json; charset=utf-8') {\n            if (response.statusCode === 204) {\n                // Probably a DELETE\n                callback(null, response, body);\n                return;\n            }\n            res.json().then(json => {\n                response.body = json;\n                callback(null, response, json);\n            }, err => {\n                callback(err, response, body);\n            });\n            return;\n        }\n        res.text().then(text => {\n            const response = fetchToRequestResponse(options, res);\n            response.body = text;\n            callback(null, response, text);\n        }, err => {\n            callback(err, response, body);\n        });\n    }, err => {\n        teenyRequest.stats.requestFinished();\n        callback(err, null, null);\n    });\n    return;\n}\nexports.teenyRequest = teenyRequest;\nteenyRequest.defaults = (defaults) => {\n    return (reqOpts, callback) => {\n        const opts = { ...defaults, ...reqOpts };\n        if (callback === undefined) {\n            return teenyRequest(opts);\n        }\n        teenyRequest(opts, callback);\n    };\n};\n/**\n * Single instance of an interface for keeping track of things.\n */\nteenyRequest.stats = new TeenyStatistics_1.TeenyStatistics();\nteenyRequest.resetStats = () => {\n    teenyRequest.stats = new TeenyStatistics_1.TeenyStatistics(teenyRequest.stats.getOptions());\n};\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"script"}